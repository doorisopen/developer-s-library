# story14. 서버를 어떻게 세팅해야 할까?
생성일: 2022년 6월 28일 오후 9:42

# 설정해야 하는 대상

- 웹 서버 세팅
- WAS 서버 세팅
- DB 서버 세팅
- 장비 세팅

## 아파치 웹 서버 설정

WAS를 웹 서버로 사용하면 안된다.

정적인 부분은 웹 서버에서 처리하고 그 외는 WAS에서 처리하도록 한다.

아파치 웹 서버는 MPM(Multi-Processing Module)을 사용한다. 다시말해 여러 개의 프로세싱 모듈 기반의 서비스를 제공한다는 의미이다.

아파치 웹 서버의 설정을 바꾸는 방법은, 설치 폴더 하단의 conf 디렉터리에 있는 httpd.conf 파일을 수정하면 된다.

```java
ThreadPerChild 250 // 웹 서버가 사용하는 스레드의 개수, 프로세스 당 250개 스레드 생성됨
MaxRequestPerChild 0 // 최대 요청 개수를 지정, 0이면 제한을 두지 않는다는 의미, 
										 // 만약 10으로 두면 10을 넘지 않게 됨 0(기본값)으로 설정하는 것을 권장
```

 

스레드와 관련된 내용을 세밀하게 지정하려면 httpd.conf 파일 중 “Include conf/extra/httpd-mpm.conf”를 찾아서 주석을 해제한다. 이렇게 하면 세민한 스레드 설정 정보를 httpd-mpm.conf를 통해서 지정할 수 있게 된다.

```java
...
<IfModule mpm_worker_module>
StartServer 2
MaxClients 150
MinSpareThreads 25
MaxSpareThreads 75
ThreadsPerChild 25
MaxRequestsPerChild 0
</IfModule>
...
```

- StartServers: 서버를 띄울 때 프로세스의 개수를 지정한다.
    - 보통 이야기하는 child 프로세스의 개수를 이야기한다.
- MaxClients: 최대 처리 가능한 클라이언트의 수를 지정한다.
- MinSpareThreads: 최소 여유 스레드 수를 지정한다.
- MaxSpareThreads: 최대 여유 스레드 수를 지정한다.
- ThreadsPerChild: 프로세스당 스레드 수를 지정한다.
- MaxRequestsPerChild: 앞서 이야기한 MaxRequestsPerChild와 같은 의미

### 사용자가 늘어나거나 WAS가 멈추는 상황

어떤 서비스가 초당 150명의 요청을 받고 있다고 가정

웹 서버에서 150명의 요청을 받고, 그 요청을 전달받은 WAS도 150명의 요청을 받는다.

그런데, 자바는 GC를 할 때 JVM 자체가 멈춘다. 만약 GC가 2초 걸리면 어떻게 될까?

아파치 웹 서버에 총 300명의 요청이 기다리게 된다. 그런데 GC를 하는 동안 WAS가 멈추기 때문에 새로운 연결을 할 수 없다.

이 경우 Tomcat에서는 AJP Connector 라는 웹 서버와 WAS 사이의 커넥터에 설정한 backlog라는 값(설정하지 않으면 100이 기본값)의 영향을 받는다.

즉, WAS가 응답하지 않을 때 100개의 요청까지 큐에 담아둔다는 의미이다.

만약 100개를 넘는 요청들은 **503(Service Unavailable) HTTP 헤더 코드 값**을 리턴 받게 된다.

조치방안

1. 서버를 늘린다. → 간단한 방법, 비용 부담이 있다.
2. 서비스를 튜닝한다. → 서비스가 응답이 안 되는 원인을 찾고 튜닝한다. 많은 시간이 소모될 수 있다.
3. GC 튜닝을 한다. → GC가 오래 소요되어 응답이 안될 경우 수행
4. 각종 옵션 값을 튜닝한다. → 더 큰 문제를 야기할 수 있으니 전문가와 진행하는 것이 좋다.

## 웹 서버의 Keep Alive

웹 서버 설정 시 중요한 값이 Keep Alive 이다.

해당 설정은 httpd.conf 파일에 다음과 같이 추가하면된다.

```java
KeppAlive On
```

웹 서버와 웹 브라우저가 연결 되어있을 때 KeepAlive 기능이 켜져 있지 않으면, 매번 HTTP 연결 작업을 반복한다. 초기 화면이 단순한 경우 KeepAlive가 적용되지 않더라도 그리 느리지 않을 것이다. 그러나 초기화면이 복잡한 경우(네이버 포탈) 해당 옵션이 적용되어 있지 않으면 오래 걸릴 것 이다.

즉, 이미지와 같은 모든 개체들도 서버에 매번 접속을 해야 하는 상황이 발생한다.

> 사용자의 접근이 많은 사이트에서는 **이미지나 CSS와 같이 정적인 파일들을** 일반적인 웹 서버에서 처리하지 않고 **CDN(Content Delivery Network)라고 하는 서비스를 사용**한다. 즉, 별도의 URL에서 해당 컨텐츠들을 내려받도록 설정하고, 동적인 컨텐츠들은 WAS에서 처리하도록 해 놓으면 Web-WAS 서버의 부담도 줄어들게 된다.(비용 부담이 있음)
> 

추가로 다음 설정도 함께 해줘야한다

```java
KeepAliveTimeout 15
```

이 설정은 초 단위로 KeepAlive가 끊기는 시간을 설정하기 위한 부분이다. 마지막 연결이 끝난 후 다음 연결이 될 때까찌 얼마나 기다릴지를 지정한다.

사용자가 많으면 5초 정도로 짧게 주는 것도 서버의 리소스를 보다 효율적으로 사용할 수 있는 방법이다.

# DB Connection Pool 및 스레드 개수 설정

DB Connection Pool과 스레드 사용은 메모리와 관련이 있다. 많이 사용할 수 록 메모리를 많이 점유하게 된다. 그렇다고 메모리를 위해서 DB Connection Pool과 스레드 개수를 적게 지정하면, 서버에서는 많은 요청을 처리하지 못하고 대기할 수밖에 없다.

대부분 WAS에서는 DB Connection Pool의 개수를 최소치, 증가치, 최대치 등으로 자세하게 지정할 수 있다. 최소치는 말 그대로 서버가 기동될 때 연결을 수행하는 개수이다.

- 개발 환경에서는 DB Connection Pool 개수를 최소한으로 지정한다.
    - 최소 개수가 많을수록 서버 기동하는 시간이 오래 소요된다.
- 운영 환경에서는 **최소 및 최대 값을 동일**하게 하는 것이 좋다.
    - 사용자 수가 갑자기 증가하면 DB Connection Pool의 개수도 증가되어야 하고, 증가할 때 대기 시간이 발생할 확률이 크기 때문이다.
    - 만약 DB 서버의 리소스가 부족하면 최소 값을 적게 설정하는 것도 방법이 될 수 있다.
- 대부분 WAS에서 두 설정(최소, 최대) 값의 기본 개수가 10~20개이다.
    - 운영 환경에서는 DB Connection Pool는 보통 40~50개로 지정
    - 스레드는 DB Connection Pool 개수보다 10개 정도 더 지정
    - 스레드 개수가 DB Connection Pool의 개수보다 적으면 적은 수만큼의 연결은 필요 없기 때문

### 스레드의 개수가 DB 연결 개수보다 많아야 하는 이유

모든 애플리케이션이나 화면이 DB에 접속하는 것은 아니다. 또한 관리자 콘솔을 사용하여 서버에 접속할 수도 있기 때문에, 그만큼 여유분을 갖도록 지정하는 것이 보통이다.

서비스 및 서버의 상황에 맞게 값을 설정하는 것이 중요하다. 가장 좋은 방법은 성능 테스트를 통해서 가장 적절한 값을 구하는 것이다.

### DB Connection 대기 시간(wait time)

Mybatis와 같이 DB와 자바 프로그램을 매핑해 주는 프레임워크에는 각종 설정 값들이 있다. 이 값 중 대기 시간을 나타내는 wait time 과 관련된 값들이 존재한다.

이 값이 중요한 이유는 DB Connection Pool의 개수를 넘어 섰을 때 애플리케이션에서는 남는 Connection을 찾으며 기다리게 된다. 이때 기다리는 시간이 **대기 시간**이다.

**Mybatis에서는 `poolTimeToWait` 라는 값으로 이 대기 시간을 결정**한다.(기본은 20초)

다시말해, 기본값으로 설정된 경우 DB 연결을 못해 기다리는 사용자들이 적어도 20초는 대기해야 한다는 말이다.

만약 대기 시간을 짧게 둔다면 어떻까?

GC 튜닝을 예시로 이야기하면, 메모리를 1GB로 할당한 WAS에서 300ms 이하의 Full GC 시간을 만들기는 매우 어렵다. 만약 DB 연결을 하려고 대기하는 순간 Full GC가 발생하면 그 순간에 대기하고 있는 모든 스레드는 DB와 연결을 못했다고 Timeout을 내뿜을 수 있다.

# WAS 인스턴스 개수 설정

서버의 WAS 인스턴스 개수를 늘리면 늘릴수록 CPU가 처리해야 하는 양이 많아진다.

장비 하나당 인스턴스 개수는 성능 테스트를 통해서 구하는 것이 바람직하다.

예를 들어 CPU core 개수가 36개인 장비가 있다고 하자

이 경우 인스턴스를 36개를 띄워야 할까? 인스턴스 1개일 때 500 TPS, 2개일 때 700TPS, 3개일 때 720TPS가 나온다고 할때 인스턴스를 2~3개 정도만 띄우는 게 좋다. 인스턴스를 더 늘린다고 해서 TPS가 증가하지 않는 상황에서는 오히려 유지보수성만 떨어지기 때문이다. 한 번 개발해놓고 수정하지 않는 시스템은 없기 때문에 인스턴스 개수가 많을 수록 배포하기도 어렵고, 모니터링 및 장애 상황 시 문제를 찾고 해결하기 어려워 진다.

또한, WAS 장비에 4GB의 여유 메모리가 있다고 해서 한 인스턴스에 4GB의 메모리를 지정하는 것은 좋지 않은 방법이다. 왜냐하면 Full GC가 발생할 때마다 많은 시간이 소요될 확률이 커지기 때문이다. 512MB~2GB 사이에서 메모리를 지정하는 것이 좋다.